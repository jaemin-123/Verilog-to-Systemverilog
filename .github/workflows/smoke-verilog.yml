      - name: Verilator Lint (all .v under repo)
        run: |
          git ls-files -z "*.v" | xargs -0 -r verilator --lint-only -Wall -Wno-DECLFILENAME

      - name: Icarus Simulation (auto-discover tb_*.v under examples/)
        run: |
          set -e
          PASSED=0
          FAILED=0
          # 공백 안전 탐색
          while IFS= read -r -d '' tb; do
            dir=$(dirname "$tb")
            tbn=$(basename "$tb" .v)
            # 같은 폴더의 다른 .v를 모으기(공백 안전)
            mapfile -d '' -t srclist < <(find "$dir" -maxdepth 1 -type f -name '*.v' ! -name "$(basename "$tb")" -print0)
            if [ ${#srclist[@]} -eq 0 ]; then
              echo "::warning::No RTL found next to $tb, skipping"
              continue
            fi
            echo "=== Building $tbn in $dir ==="
            iverilog -g2005 -o simv "$tb" "${srclist[@]}"
            if vvp simv; then
              echo "=== PASS: $tbn ==="
              PASSED=$((PASSED+1))
            else
              echo "::error::Simulation failed for $tbn"
              FAILED=$((FAILED+1))
            fi
            rm -f simv
          done < <(find examples -type f -name 'tb_*.v' -print0)
          echo "Passed: $PASSED  Failed: $FAILED"
          [ $FAILED -eq 0 ]
