name: smoke-verilog

on:
  push:
  pull_request:

jobs:
  lint-and-sim:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (Icarus Verilog & Verilator)
        run: |
          sudo apt-get update
          sudo apt-get install -y iverilog verilator

      # 공백 있는 경로도 안전하게 처리 (B안)
      - name: Verilator Lint (all .v under repo)
        run: |
          git ls-files -z "*.v" | xargs -0 -r verilator --lint-only -Wall -Wno-DECLFILENAME

      - name: Icarus Simulation (auto-discover tb_*.v under examples/)
        run: |
          set -e
          PASSED=0
          FAILED=0
          # examples/**/tb_*.v 탐색 (공백 안전)
          while IFS= read -r -d '' tb; do
            dir=$(dirname "$tb")
            tbn=$(basename "$tb" .v)
            # 같은 폴더의 다른 .v 수집 (공백 안전)
            mapfile -d '' -t srclist < <(find "$dir" -maxdepth 1 -type f -name '*.v' ! -name "$(basename "$tb")" -print0)
            if [ ${#srclist[@]} -eq 0 ]; then
              echo "::warning::No RTL found next to $tb, skipping"
              continue
            fi
            echo "=== Building $tbn in $dir ==="
            iverilog -g2005 -o simv "$tb" "${srclist[@]}"
            if vvp simv; then
              echo "=== PASS: $tbn ==="
              PASSED=$((PASSED+1))
            else
              echo "::error::Simulation failed for $tbn"
              FAILED=$((FAILED+1))
            fi
            rm -f simv
          done < <(find examples -type f -name 'tb_*.v' -print0)
          echo "Passed: $PASSED  Failed: $FAILED"
          [ $FAILED -eq 0 ]
          
